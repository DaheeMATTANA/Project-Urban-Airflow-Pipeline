version: 2

models:
  - name: int_station_status_aggregated
    description: "Intermediate station status model with aggregation + timezone conversion"
    columns:
      - name: station_id
        description: "Id of the VÃ©lib station"
        data_type: string
        tests:
          - not_null

      - name: last_reported_hourly_utc
        description: "Timestamp of the last reported time in UTC (hourly granularity)"
        data_type: timestamp

      - name: last_reported_hourly_cet
        description: "Timestamp of the last reported time in CET/CEST (hourly granularity)"
        data_type: timestamp

      - name: is_installed
        description: "True if the station is operational, false if being developed"
        data_type: boolean

      - name: is_renting
        description: "True if the station is capable to rent bikes, false otherwise"
        data_type: boolean

      - name: is_returning
        description: "True if the station is capable to receive a return, false otherwise"
        data_type: boolean

      - name: station_capacity
        description: "Capacity of the station"
        data_type: integer

      - name: avg_num_bikes_available
        description: "Average number of bikes available of the station at the given time"
        data_type: integer

      - name: avg_num_docks_available
        description: "Number of bike docks available (empty) of the station at the given time"
        data_type: integer

      - name: pct_time_full
        description: "Percentage of time that the station was full (no available docks)."
        data_type: float

      - name: pct_time_empty
        description: "Percentage of time that the station was empty (no available bikes) "
        data_type: float

      - name: avg_num_bikes_in_maintenance
        description: "Average bikes unavailable or under maintenance of the station at the given time"
        data_type: integer

    tests:
      - dbt_utils.expression_is_true:
          arguments:
            expression: "last_reported_hourly_utc < last_reported_hourly_cet" 
            severity: warn

      - dbt_utils.expression_is_true:
          arguments:
            expression: "avg_num_bikes_available <= station_capacity" 
            severity: warn

      - dbt_utils.expression_is_true:
          arguments:
            expression: "avg_num_docks_available <= station_capacity" 
            severity: warn

      - dbt_utils.expression_is_true:
          arguments:
            expression: "avg_num_bikes_in_maintenance >= 0" 
            severity: warn